---
title: "Kaspian mites"
author: "Sozontov"
date: "2022-11-10"
output:
  html_document: 
    toc: yes
    toc_float: yes
    code_folding: hide
    toc_depth: 2
    dev: 'svg'
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Загрузка{.tabset}

## Пакеты

```{r packages_load}
library(vegan)
library(tidyverse)
theme_set(theme_bw() + theme(legend.position = "bottom"))

collapse_labels <- function(a){
    paste(names(sort(table(a), decreasing = TRUE)), collapse = " or ")
}

colorise_labels <- function(a) {
    n <- length(unique(a))
    clr <- hcl(h = seq(15, 375, length = n + 1), 
               l = 65, c = 100)[1:n]
    data.frame(l = unique(a), clr = clr) %>% 
        left_join(data.frame(l = a), ., by = "l") %>% 
        pull(clr)
}
```

## Данные{.tabset}

### Acari

```{r dataLoad}
load(paste0(Sys.Date(), "_results.RData"))
formattable::formattable(dfw)
```

### Taxa

```{r}
formattable::formattable(taxa)
```

### Results

```{r}
formattable::formattable(div)
```

# Вопрос 5 {.tabset}

5. Связано ли видовое разнообразие почвенных клещей (Oribatida, Mesostigmata) отдельных типов берега со сложностью растительного покрова (числом гипсометрических зон, биотопов или синузий видов сосудистых растений)?

— Связано, на песчаном пляже видовое богатство выше, но надо «выровнять» по числу проб.

*требуется стандартизация c iNEXT*

**Примечание. Применение разрежения и эксраполяции для нивелирования различий между объемами выборки на результат почти не влияет**

Обозначения: 
abu (abundance) - Обилие
shan (Shannon' index) - мера разнообразия Шеннона
nsp (number of species) - количество видов
i10 - ожидаемое количество видов в пробе из 10 особей 
120 - ожидаемое количество видов в пробе из 20 особей 
i25 - ожидаемое количество видов в пробе из 25 особей 

```{r}

```

## coast type

```{r}
div %>% 
    pivot_longer(names_to = "diversity", 
                 values_to = "val", -c(7:ncol(.))) %>% 
    ggplot(aes(x = coast, y = val, fill = coast)) + 
    geom_boxplot() + 
    facet_wrap(~diversity, scales = "free") + 
    labs(y = NULL, x = NULL, title = "Diversity ~ coast type") + 
    theme(axis.text.x = element_text(angle = 15, vjust = 0.7))
```

## Skew

```{r}
div %>% 
    pivot_longer(names_to = "diversity", values_to = "val", -c(7:ncol(.))) %>% 
    ggplot(aes(x = skew, y = val, fill = skew)) + 
    geom_boxplot() + 
    facet_wrap(~diversity, scales = "free") + 
    labs(y = NULL, x = NULL, title = "Diversity ~ skew") + 
    theme(axis.text.x = element_text(angle = 15, vjust = 0.7))
```

## soil type

```{r}
div %>% 
    pivot_longer(names_to = "diversity", values_to = "val", -c(7:ncol(.))) %>% 
    ggplot(aes(x = soil, y = val, fill = soil)) + 
    geom_boxplot() + 
    facet_wrap(~diversity, scales = "free") + 
    labs(y = NULL, x = NULL, title = "Diversity ~ soil type") + 
    theme(axis.text.x = element_text(angle = 15, vjust = 0.7))
```

## substrate type

```{r}
div %>% 
    pivot_longer(names_to = "diversity", values_to = "val", -c(7:ncol(.))) %>% 
    ggplot(aes(x = substrate, y = val, fill = substrate)) + 
    geom_boxplot() + 
    facet_wrap(~diversity, scales = "free") + 
    labs(y = NULL, x = NULL, title = "Diversity ~ substrate type") + 
    theme(axis.text.x = element_text(angle = 15, vjust = 0.7))
```

## Zone

```{r}
div %>% 
    pivot_longer(names_to = "diversity", values_to = "val", -c(7:ncol(.))) %>% 
    ggplot(aes(x = zone, y = val, fill = zone)) + 
    geom_boxplot() + 
    facet_wrap(~diversity, scales = "free") + 
    labs(y = NULL, x = NULL, title = "Diversity ~ zone") + 
    theme(axis.text.x = element_text(angle = 15, vjust = 0.7))
```

## vegetation cover

```{r}
div %>% 
    pivot_longer(names_to = "diversity", values_to = "val", -c(7:ncol(.))) %>% 
    ggplot(aes(x = veg, y = val, fill = veg)) + 
    geom_boxplot() + 
    facet_wrap(~diversity, scales = "free") + 
    labs(y = NULL, x = NULL, title = "Diversity ~ vegetation cover") + 
    theme(axis.text.x = element_text(angle = 15, vjust = 0.7))
```

## Кол-во видов в доминантном комплексе

```{r}
div %>% 
    pivot_longer(names_to = "diversity", values_to = "val", -c(7:ncol(.))) %>% 
    ggplot(aes(x = dom.comp, y = val, fill = dom.comp)) + 
    geom_boxplot() + 
    facet_wrap(~diversity, scales = "free") + 
    labs(y = NULL, x = NULL, title = "Diversity ~ Dominant complex", 
         subtitle = "Кол-во видов растений в доминантном комплексе")
```

# Вопрос 5а

Кривые разрежения 

## По отдельным пробам  {.tabset}

```{r}
rar2 <- dfw %>% 
    select(-sp) %>% 
    lapply(function(a){sort(a[a>0], decreasing = TRUE)}) %>% 
    discard(~ length(.x) < 2) %>% 
    iNEXT::iNEXT(., q = 0, size = seq(5, 150, by = 5), #anchor_A
                 datatype = "abundance", nboot = 9) %>% # 999
    pluck("iNextEst", "size_based") %>% 
    transmute(id = Assemblage, Method, m, qD, qD.LCL, qD.UCL) %>% 
    as_tibble() %>%
    left_join(., select(labs, id, coast, skew, soil, 
        substrate, zone, veg, dom.comp), by = "id")
obs2 <- rar2 %>% 
    filter(Method == "Observed") %>% 
    mutate(r = case_when(m >= 150 ~ "up", m <= 5 ~ "low", TRUE ~ "r"), 
           m = case_when(m < 5 ~ 5, 
                         m > 150  ~ 150, 
                         TRUE ~ m))
rar2.rar <- rar2 %>% 
    filter(Method != "Extrapolation", m <= 150, m >= 5) %>%
    filter(m %in% seq(5, 150, by = 5) | Method == "Observed")

rar2.ext <- rar2 %>% 
    filter(Method != "Rarefaction", m <= 150, m >= 5) %>%
    filter(m %in% seq(5, 150, by = 5) | Method == "Observed")
```

### Coast

```{r}
ggplot(mapping = aes(x = m, y = qD, size = id, color = coast, fill = coast)) + 
    scale_size_manual(values = rep(1, 59)) +
    geom_line(data = rar2.ext, linetype = "dotted", alpha = 0.7) +
    geom_line(data = rar2.rar, alpha = 0.5) + 
    geom_text(mapping = aes(x = 155, y = qD, label = id), size = 3.5, show.legend=FALSE,
       data = summarise(group_by(rar2, id, coast), qD = max(qD), .groups = "drop")) +
    geom_point(mapping = aes(x = m, y = qD, size = id, fill = coast, shape = r), 
               data = obs2, size = 3, color = "black", show.legend=FALSE,) +
    scale_shape_manual(values = c(25, 21, 24)) +
    labs(x = "individuals", y = "number of species") +
    theme(legend.position = c(0.1, 0.86), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    guides(size = "none", shape = "none")
```

### Skew

```{r}
ggplot(mapping = aes(x = m, y = qD, size = id, color = skew, fill = skew)) + 
    scale_size_manual(values = rep(1, 59)) +
    geom_line(data = rar2.ext, linetype = "dotted", alpha = 0.7) +
    geom_line(data = rar2.rar, alpha = 0.5) + 
    geom_text(mapping = aes(x = 155, y = qD, label = id), size = 3.5, show.legend=FALSE,
       data = summarise(group_by(rar2, id, skew), qD = max(qD), .groups = "drop")) +
    geom_point(mapping = aes(x = m, y = qD, size = id, fill = skew, shape = r), 
               data = obs2, size = 3, color = "black", show.legend=FALSE,) +
    scale_shape_manual(values = c(25, 21, 24)) +
    labs(x = "individuals", y = "number of species") +
    theme(legend.position = c(0.1, 0.86), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    guides(size = "none", shape = "none")
```

### Soil

```{r}
ggplot(mapping = aes(x = m, y = qD, size = id, color = soil, fill = soil)) + 
    scale_size_manual(values = rep(1, 59)) +
    geom_line(data = rar2.ext, linetype = "dotted", alpha = 0.7) +
    geom_line(data = rar2.rar, alpha = 0.5) + 
    geom_text(mapping = aes(x = 155, y = qD, label = id), size = 3.5, show.legend=FALSE,
       data = summarise(group_by(rar2, id, soil), qD = max(qD), .groups = "drop")) +
    geom_point(mapping = aes(x = m, y = qD, size = id, fill = soil, shape = r), 
               data = obs2, size = 3, color = "black", show.legend=FALSE,) +
    scale_shape_manual(values = c(25, 21, 24)) +
    labs(x = "individuals", y = "number of species") +
    theme(legend.position = c(0.1, 0.86), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    guides(size = "none", shape = "none")
```

### Substrate

```{r}
ggplot(mapping = aes(x = m, y = qD, size = id, color = substrate, fill = substrate)) + 
    scale_size_manual(values = rep(1, 59)) +
    geom_line(data = rar2.ext, linetype = "dotted", alpha = 0.7) +
    geom_line(data = rar2.rar, alpha = 0.5) + 
    geom_text(mapping = aes(x = 155, y = qD, label = id), size = 3.5, show.legend=FALSE,
       data = summarise(group_by(rar2, id, substrate), qD = max(qD), .groups = "drop")) +
    geom_point(mapping = aes(x = m, y = qD, size = id, fill = substrate, shape = r), 
               data = obs2, size = 3, color = "black", show.legend=FALSE,) +
    scale_shape_manual(values = c(25, 21, 24)) +
    labs(x = "individuals", y = "number of species") +
    theme(legend.position = c(0.1, 0.86), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    guides(size = "none", shape = "none")
```

### Zone

```{r}
ggplot(mapping = aes(x = m, y = qD, size = id, color = zone, fill = zone)) + 
    scale_size_manual(values = rep(1, 59)) +
    geom_line(data = rar2.ext, linetype = "dotted", alpha = 0.7) +
    geom_line(data = rar2.rar, alpha = 0.5) + 
    geom_text(mapping = aes(x = 155, y = qD, label = id), size = 3.5, show.legend=FALSE,
       data = summarise(group_by(rar2, id, zone), qD = max(qD), .groups = "drop")) +
    geom_point(mapping = aes(x = m, y = qD, size = id, fill = zone, shape = r), 
               data = obs2, size = 3, color = "black", show.legend=FALSE,) +
    scale_shape_manual(values = c(25, 21, 24)) +
    labs(x = "individuals", y = "number of species") +
    theme(legend.position = c(0.1, 0.86), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    guides(size = "none", shape = "none")
```

### Vegetation

```{r}
ggplot(mapping = aes(x = m, y = qD, size = id, color = veg, fill = veg)) + 
    scale_size_manual(values = rep(1, 59)) +
    geom_line(data = rar2.ext, linetype = "dotted", alpha = 0.7) +
    geom_line(data = rar2.rar, alpha = 0.5) + 
    geom_text(mapping = aes(x = 155, y = qD, label = id), size = 3.5, show.legend=FALSE,
       data = summarise(group_by(rar2, id, veg), qD = max(qD), .groups = "drop")) +
    geom_point(mapping = aes(x = m, y = qD, size = id, fill = veg, shape = r), 
               data = obs2, size = 3, color = "black", show.legend=FALSE,) +
    scale_shape_manual(values = c(25, 21, 24)) +
    labs(x = "individuals", y = "number of species") +
    theme(legend.position = c(0.1, 0.7), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    guides(size = "none", shape = "none")
```

### Dominant complex

```{r}
ggplot(mapping = aes(x = m, y = qD, size = id, color = dom.comp, fill = dom.comp)) + 
    scale_size_manual(values = rep(1, 59)) +
    geom_line(data = rar2.ext, linetype = "dotted", alpha = 0.7) +
    geom_line(data = rar2.rar, alpha = 0.5) + 
    geom_text(mapping = aes(x = 155, y = qD, label = id), size = 3.5, show.legend=FALSE,
       data = summarise(group_by(rar2, id, dom.comp), qD = max(qD), .groups = "drop")) +
    geom_point(mapping = aes(x = m, y = qD, size = id, fill = dom.comp, shape = r), 
               data = obs2, size = 3, color = "black", show.legend=FALSE,) +
    scale_shape_manual(values = c(25, 21, 24)) +
    labs(x = "individuals", y = "number of species") +
    theme(legend.position = c(0.1, 0.7), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    guides(size = "none", shape = "none")
```

## По участкам (пробы объединены по 5)  {.tabset}

```{r}
rar3 <- dfw0 %>% 
    select(-sp) %>% 
    lapply(function(a){sort(a[a>0], decreasing = TRUE)}) %>% 
    discard(~ length(.x) < 2) %>% 
    iNEXT::iNEXT(., q = 0, size = seq(5, 300, by = 5), #anchor_A
                 datatype = "abundance", nboot = 9) %>% # 999
    pluck("iNextEst", "size_based") %>% 
    transmute(id = Assemblage, Method, m, qD, qD.LCL, qD.UCL) %>% 
    as_tibble() %>%
    filter(id != "SmSw")
rar3 <- labs %>% 
    mutate(id = substr(id, 1, nchar(id)-1)) %>% 
    select(id, coast, skew, soil, substrate, zone, veg, dom.comp) %>% 
    distinct() %>% 
    left_join(rar3, ., by = "id")

obs3 <- rar3 %>% 
    filter(Method == "Observed" | m >= 300) %>% 
    mutate(Method = "Observed") %>% 
    group_by(id, Method) %>%
    summarise(qD = min(qD), m = min(m), coast = unique(coast), 
              skew = unique(skew), soil = unique(soil),
              substrate = unique(substrate), zone = unique(zone),
              veg = unique(veg), dom.comp = unique(dom.comp),
              .groups = "drop") %>%
    mutate(r = case_when(m == 300 ~ "up", TRUE ~ "r"))

rar3.rar <- rar3 %>% 
    filter(Method != "Extrapolation", m <= 300, m >= 5) %>%
    filter(m %in% seq(5, 300, by = 5) | Method == "Observed")
rar3.ext <- rar3 %>% 
    filter(Method != "Rarefaction", m <= 300, m >= 5) %>%
    filter(m %in% seq(5, 300, by = 5) | Method == "Observed")
```

### Coast

```{r}
ggplot(mapping = aes(x = m, y = qD, size = id, color = coast, fill = coast)) + 
    geom_line(data = rar3.ext, linetype = "dotted", alpha = 0.7) +
    geom_line(data = rar3.rar, alpha = 0.5) + 
    geom_text(mapping = aes(x = 315, y = qD, label = id), 
        size = 3.5, show.legend=FALSE, 
        data = filter(rar3, m == 300)) +
    geom_point(mapping = aes(shape = r), 
               data = obs3, size = 3, color = "black", show.legend=FALSE,) +
    scale_shape_manual(values = c(21, 24)) +
    scale_size_manual(values = rep(1, 59)) +
    labs(x = "individuals", y = "number of species") +
    theme(legend.position = c(0.1, 0.86), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    guides(size = "none", shape = "none")
```

### Skew

```{r}
ggplot(mapping = aes(x = m, y = qD, size = id, color = skew, fill = skew)) + 
    geom_line(data = rar3.ext, linetype = "dotted", alpha = 0.7) +
    geom_line(data = rar3.rar, alpha = 0.5) + 
    geom_text(mapping = aes(x = 315, y = qD, label = id), 
        size = 3.5, show.legend=FALSE, 
        data = filter(rar3, m == 300)) +
    geom_point(mapping = aes(shape = r), 
               data = obs3, size = 3, color = "black", show.legend=FALSE,) +
    scale_shape_manual(values = c(21, 24)) +
    scale_size_manual(values = rep(1, 59)) +
    labs(x = "individuals", y = "number of species") +
    theme(legend.position = c(0.1, 0.86), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    guides(size = "none", shape = "none")
```

### Soil

```{r}
ggplot(mapping = aes(x = m, y = qD, size = id, color = soil, fill = soil)) + 
    geom_line(data = rar3.ext, linetype = "dotted", alpha = 0.7) +
    geom_line(data = rar3.rar, alpha = 0.5) + 
    geom_text(mapping = aes(x = 315, y = qD, label = id), 
        size = 3.5, show.legend=FALSE, 
        data = filter(rar3, m == 300)) +
    geom_point(mapping = aes(shape = r), 
               data = obs3, size = 3, color = "black", show.legend=FALSE,) +
    scale_shape_manual(values = c(21, 24)) +
    scale_size_manual(values = rep(1, 59)) +
    labs(x = "individuals", y = "number of species") +
    theme(legend.position = c(0.1, 0.86), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    guides(size = "none", shape = "none")
```

### Substrate

Единственная проба с дебрисом удалена

```{r}
ggplot(mapping = aes(x = m, y = qD, size = id, color = substrate, fill = substrate)) + 
    geom_line(data = rar3.ext, linetype = "dotted", alpha = 0.7) +
    geom_line(data = rar3.rar, alpha = 0.5) + 
    geom_text(mapping = aes(x = 315, y = qD, label = id), 
        size = 3.5, show.legend=FALSE, 
        data = filter(rar3, m == 300)) +
    geom_point(mapping = aes(shape = r), 
               data = obs3, size = 3, color = "black", show.legend=FALSE,) +
    scale_shape_manual(values = c(21, 24)) +
    scale_size_manual(values = rep(1, 59)) +
    labs(x = "individuals", y = "number of species") +
    theme(legend.position = c(0.1, 0.86), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    guides(size = "none", shape = "none")
```

### Zone

```{r}
ggplot(mapping = aes(x = m, y = qD, size = id, color = zone, fill = zone)) + 
    geom_line(data = rar3.ext, linetype = "dotted", alpha = 0.7) +
    geom_line(data = rar3.rar, alpha = 0.5) + 
    geom_text(mapping = aes(x = 315, y = qD, label = id), 
        size = 3.5, show.legend=FALSE, 
        data = filter(rar3, m == 300)) +
    geom_point(mapping = aes(shape = r), 
               data = obs3, size = 3, color = "black", show.legend=FALSE,) +
    scale_shape_manual(values = c(21, 24)) +
    scale_size_manual(values = rep(1, 59)) +
    labs(x = "individuals", y = "number of species") +
    theme(legend.position = c(0.1, 0.86), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    guides(size = "none", shape = "none")
```

### Vegetation

```{r}
ggplot(mapping = aes(x = m, y = qD, size = id, color = veg, fill = veg)) + 
    geom_line(data = rar3.ext, linetype = "dotted", alpha = 0.7) +
    geom_line(data = rar3.rar, alpha = 0.5) + 
    geom_text(mapping = aes(x = 315, y = qD, label = id), 
        size = 3.5, show.legend=FALSE, 
        data = filter(rar3, m == 300)) +
    geom_point(mapping = aes(shape = r), 
               data = obs3, size = 3, color = "black", show.legend=FALSE,) +
    scale_shape_manual(values = c(21, 24)) +
    scale_size_manual(values = rep(1, 59)) +
    labs(x = "individuals", y = "number of species") +
    theme(legend.position = c(0.07, 0.76), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    guides(size = "none", shape = "none")
```

### Dominant complex

```{r}
ggplot(mapping = aes(x = m, y = qD, size = id, color = dom.comp, fill = dom.comp)) + 
    geom_line(data = rar3.ext, linetype = "dotted", alpha = 0.7) +
    geom_line(data = rar3.rar, alpha = 0.5) + 
    geom_text(mapping = aes(x = 315, y = qD, label = id), 
        size = 3.5, show.legend=FALSE, 
        data = filter(rar3, m == 300)) +
    geom_point(mapping = aes(shape = r), 
               data = obs3, size = 3, color = "black", show.legend=FALSE,) +
    scale_shape_manual(values = c(21, 24)) +
    scale_size_manual(values = rep(1, 59)) +
    labs(x = "individuals", y = "number of species") +
    theme(legend.position = c(0.07, 0.75), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    guides(size = "none", shape = "none")
```

## Усреднены данные {.tabset}

```{r}
support <- function(B){
    B %>% 
    select(-sp) %>% 
    lapply(function(a){sort(a[a>0], decreasing = TRUE)}) %>% 
    discard(~ length(.x) < 2) %>% 
    iNEXT::iNEXT(., q = 0, size = seq(30, 3000, by = 30), #anchor_A
                 datatype = "abundance", nboot = 9) %>% # 999
    pluck("iNextEst", "size_based") %>% 
    transmute(type = Assemblage, Method, m, qD, qD.LCL, qD.UCL) %>% 
    as_tibble() %>% 
    pivot_wider(names_from = Method, values_from = "qD") %>% 
    pivot_longer(names_to = "Method", values_to = "qD", -c(1:4, 6)) %>% 
    filter(!is.na(Observed) | !is.na(qD))
}
```

### Coast

```{r}
dfl %>% 
    left_join(select(labs, id, coast), by = "id") %>% 
    group_by(coast, sp) %>% 
    summarise(abu = sum(abu), .groups = "drop") %>% 
    pivot_wider(values_from = "abu", names_from = "coast") %>% 
    support %>% 
    ggplot(aes(x = m, y = qD, ymin = qD.LCL, ymax = qD.UCL, 
               color = type, fill = type, linetype = Method)) + 
    geom_ribbon(alpha = 0.2, linetype = "blank") +
    geom_line(linewidth = 1.2) +
    geom_point(mapping = aes(x = m, y = Observed), size = 3, shape = 22) +
    scale_linetype_manual(values = c("dotted", "solid")) + 
    guides(linetype = "none") +
    theme(legend.position = c(0.15, 0.8), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey"))+ 
    labs(x = "individuals", y = "number of species") 

```

### Skew

```{r}
dfl %>% 
    left_join(select(labs, id, skew), by = "id") %>% 
    group_by(skew, sp) %>% 
    summarise(abu = sum(abu), .groups = "drop") %>% 
    pivot_wider(values_from = "abu", names_from = "skew") %>% 
    support %>% 
    ggplot(aes(x = m, y = qD, ymin = qD.LCL, ymax = qD.UCL, 
               color = type, fill = type, linetype = Method)) + 
    geom_ribbon(alpha = 0.2, linetype = "blank") +
    geom_line(linewidth = 1.2) +
    geom_point(mapping = aes(x = m, y = Observed), size = 3, shape = 22) +
    scale_linetype_manual(values = c("dotted", "solid")) + 
    guides(linetype = "none") +
    theme(legend.position = c(0.15, 0.8), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey"))+ 
    labs(x = "individuals", y = "number of species") 

```

### Soil 

```{r}
dfl %>% 
    left_join(select(labs, id, soil), by = "id") %>% 
    group_by(soil, sp) %>% 
    summarise(abu = sum(abu), .groups = "drop") %>% 
    pivot_wider(values_from = "abu", names_from = "soil") %>% 
    support %>% 
    ggplot(aes(x = m, y = qD, ymin = qD.LCL, ymax = qD.UCL, 
               color = type, fill = type, linetype = Method)) + 
    geom_ribbon(alpha = 0.2, linetype = "blank") +
    geom_line(linewidth = 1.2) +
    geom_point(mapping = aes(x = m, y = Observed), size = 3, shape = 22) +
    scale_linetype_manual(values = c("dotted", "solid")) + 
    guides(linetype = "none") +
    theme(legend.position = c(0.15, 0.8), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey"))+ 
    labs(x = "individuals", y = "number of species") 

```

### Substrate 

```{r}
dfl %>% 
    left_join(select(labs, id, substrate), by = "id") %>% 
    group_by(substrate, sp) %>% 
    summarise(abu = sum(abu), .groups = "drop") %>% 
    pivot_wider(values_from = "abu", names_from = "substrate") %>% 
    support %>% 
    ggplot(aes(x = m, y = qD, ymin = qD.LCL, ymax = qD.UCL, 
               color = type, fill = type, linetype = Method)) + 
    geom_ribbon(alpha = 0.2, linetype = "blank") +
    geom_line(linewidth = 1.2) +
    geom_point(mapping = aes(x = m, y = Observed), size = 3, shape = 22) +
    scale_linetype_manual(values = c("dotted", "solid")) + 
    guides(linetype = "none") +
    theme(legend.position = c(0.15, 0.8), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey"))+ 
    labs(x = "individuals", y = "number of species") 
```

### Zone 

```{r}
dfl %>% 
    left_join(select(labs, id, zone), by = "id") %>% 
    group_by(zone, sp) %>% 
    summarise(abu = sum(abu), .groups = "drop") %>% 
    pivot_wider(values_from = "abu", names_from = "zone") %>% 
    support %>% 
    ggplot(aes(x = m, y = qD, ymin = qD.LCL, ymax = qD.UCL, 
               color = type, fill = type, linetype = Method)) + 
    geom_ribbon(alpha = 0.2, linetype = "blank") +
    geom_line(linewidth = 1.2) +
    geom_point(mapping = aes(x = m, y = Observed), size = 3, shape = 22) +
    scale_linetype_manual(values = c("dotted", "solid")) + 
    guides(linetype = "none") +
    theme(legend.position = c(0.15, 0.8), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey"))+ 
    labs(x = "individuals", y = "number of species") 
```

### Vegetation

```{r}
dfl %>% 
    left_join(select(labs, id, veg), by = "id") %>% 
    group_by(veg, sp) %>% 
    summarise(abu = sum(abu), .groups = "drop") %>% 
    pivot_wider(values_from = "abu", names_from = "veg") %>% 
    support %>% 
    mutate(type = as.numeric(type), 
             type = factor(type, ordered = TRUE)) %>% 
    ggplot(aes(x = m, y = qD, ymin = qD.LCL, ymax = qD.UCL, 
               color = type, fill = type, linetype = Method)) + 
    geom_ribbon(alpha = 0.2, linetype = "blank") +
    geom_line(linewidth = 1.2) +
    geom_point(mapping = aes(x = m, y = Observed), size = 3, shape = 22) +
    scale_linetype_manual(values = c("dotted", "solid")) + 
    guides(linetype = "none") +
    theme(legend.position = c(0.05, 0.7), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey"))+ 
    labs(x = "individuals", y = "number of species") 
```

### Dominant complex

```{r}
dfl %>% 
    left_join(select(labs, id, dom.comp), by = "id") %>% 
    group_by(dom.comp, sp) %>% 
    summarise(abu = sum(abu), .groups = "drop") %>% 
    pivot_wider(values_from = "abu", names_from = "dom.comp") %>% 
    support %>% 
    mutate(type = as.numeric(type), 
             type = factor(type, ordered = TRUE)) %>% 
    ggplot(aes(x = m, y = qD, ymin = qD.LCL, ymax = qD.UCL, 
               color = type, fill = type, linetype = Method)) + 
    geom_ribbon(alpha = 0.2, linetype = "blank") +
    geom_line(linewidth = 1.2) +
    geom_point(mapping = aes(x = m, y = Observed), size = 3, shape = 22) +
    scale_linetype_manual(values = c("dotted", "solid")) + 
    guides(linetype = "none") +
    theme(legend.position = c(0.05, 0.7), 
          legend.title = element_blank(), 
          legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey"))+ 
    labs(x = "individuals", y = "number of species") 
```


# Вопрос 5b {.tabset}

Профили Хилла

```{r}
s <- (1.045^seq(0,20,by=0.25)-1)*3
s <- s[s< 0.96 | s >= 1]
s <- s[s< 1.97 | s >= 2.05]
s <- sort(c(s, 1, 2))

#s <- c(seq(0, 2, by = 0.05), 2.05^((seq(1, 10, length.out = 16))^0.35))

hill <- dfw[,-1] %>% 
    t %>% 
    vegan::renyi(scales = s, hill = TRUE) %>% 
    rownames_to_column("id") %>% 
    as_tibble() %>% 
    pivot_longer(names_to = "ord", values_to = "H", -id) %>% 
    mutate(ord = as.numeric(ord), O = rep(0:(length(s)-1), 69)) %>% 
    left_join(select(labs, id, 
        coast, skew, zone, substrate, soil, veg, dom.comp), by = "id")
```

## Coast

```{r}
hill %>% 
    group_by(ord, O, coast) %>% 
    summarise(HH = mean(H), 
        UH = mean(H)+sd(H), 
        LH = mean(H)-sd(H), 
        .groups = "drop") %>% 
    ggplot(aes(x = O, y = HH, ymin = LH, ymax = UH, color = coast, fill = coast)) + 
    geom_ribbon(alpha = 0.2, size = 0) +
    geom_line(size = 1) + 
    scale_x_continuous(
        breaks = which(s %in% c(0, 1, 2, max(s)))-1,
        labels = c(0, 1, 2, Inf)) +
    theme(
        panel.grid.minor = element_blank(), 
        legend.position = c(0.8, 0.8), 
        legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    labs(x = "Order", y = "Hill numbers")
```

## Skew

```{r}
hill %>% 
    group_by(ord, O, skew) %>% 
    summarise(HH = mean(H), 
        UH = mean(H)+sd(H), 
        LH = mean(H)-sd(H), 
        .groups = "drop") %>% 
    ggplot(aes(x = O, y = HH, ymin = LH, ymax = UH, color = skew, fill = skew)) + 
    geom_ribbon(alpha = 0.2, size = 0) +
    geom_line(size = 1) + 
    scale_x_continuous(
        breaks = which(s %in% c(0, 1, 2, max(s)))-1,
        labels = c(0, 1, 2, Inf)) +
    theme(
        panel.grid.minor = element_blank(), 
        legend.position = c(0.8, 0.8), 
        legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    labs(x = "Order", y = "Hill numbers")
```

## Soil

```{r}
hill %>% 
    group_by(ord, O, soil) %>% 
    summarise(HH = mean(H), 
        UH = mean(H)+sd(H), 
        LH = mean(H)-sd(H), 
        .groups = "drop") %>% 
    ggplot(aes(x = O, y = HH, ymin = LH, ymax = UH, color = soil, fill = soil)) + 
    geom_ribbon(alpha = 0.2, size = 0) +
    geom_line(size = 1) + 
    scale_x_continuous(
        breaks = which(s %in% c(0, 1, 2, max(s)))-1,
        labels = c(0, 1, 2, Inf)) +
    theme(
        panel.grid.minor = element_blank(), 
        legend.position = c(0.8, 0.8), 
        legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    labs(x = "Order", y = "Hill numbers")
```

## Substrate

```{r}
hill %>% 
    group_by(ord, O, substrate) %>% 
    summarise(HH = mean(H), 
        UH = mean(H)+sd(H), 
        LH = mean(H)-sd(H), 
        .groups = "drop") %>% 
    ggplot(aes(x = O, y = HH, ymin = LH, ymax = UH, 
               color = substrate, fill = substrate)) + 
    geom_ribbon(alpha = 0.2, size = 0) +
    geom_line(size = 1) + 
    scale_x_continuous(
        breaks = which(s %in% c(0, 1, 2, max(s)))-1,
        labels = c(0, 1, 2, Inf)) +
    theme(
        panel.grid.minor = element_blank(), 
        legend.position = c(0.8, 0.8), 
        legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    labs(x = "Order", y = "Hill numbers")
```

## Zone

```{r}
hill %>% 
    group_by(ord, O, zone) %>% 
    summarise(HH = mean(H), 
        UH = mean(H)+sd(H), 
        LH = mean(H)-sd(H), 
        .groups = "drop") %>% 
    ggplot(aes(x = O, y = HH, ymin = LH, ymax = UH, color = zone, fill = zone)) + 
    geom_ribbon(alpha = 0.2, size = 0) +
    geom_line(size = 1) + 
    scale_x_continuous(
        breaks = which(s %in% c(0, 1, 2, max(s)))-1,
        labels = c(0, 1, 2, Inf)) +
    theme(
        panel.grid.minor = element_blank(), 
        legend.position = c(0.8, 0.8), 
        legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    labs(x = "Order", y = "Hill numbers")
```


## Vegetation

```{r}
hill %>% 
    group_by(ord, O, veg) %>% 
    summarise(HH = mean(H), 
        UH = mean(H)+sd(H), 
        LH = mean(H)-sd(H), 
        .groups = "drop") %>% 
    ggplot(aes(x = O, y = HH, ymin = LH, ymax = UH, 
               color = veg, fill = veg)) + 
    geom_ribbon(alpha = 0.2, size = 0) +
    geom_line(size = 1) + 
    scale_x_continuous(
        breaks = which(s %in% c(0, 1, 2, max(s)))-1,
        labels = c(0, 1, 2, Inf)) +
    theme(
        panel.grid.minor = element_blank(), 
        legend.position = c(0.8, 0.7), 
        legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    labs(x = "Order", y = "Hill numbers")
```

## Dominant complex

```{r}
hill %>% 
    group_by(ord, O, dom.comp) %>% 
    summarise(HH = mean(H), 
        UH = mean(H)+sd(H), 
        LH = mean(H)-sd(H), 
        .groups = "drop") %>% 
    ggplot(aes(x = O, y = HH, ymin = LH, ymax = UH, 
               color = dom.comp, fill = dom.comp)) + 
    geom_ribbon(alpha = 0.2, size = 0) +
    geom_line(size = 1) + 
    scale_x_continuous(
        breaks = which(s %in% c(0, 1, 2, max(s)))-1,
        labels = c(0, 1, 2, Inf)) +
    theme(
        panel.grid.minor = element_blank(), 
        legend.position = c(0.8, 0.7), 
        legend.background = element_rect(fill="white",
                                  linewidth=0.5, linetype="solid", 
                                  colour ="grey")) + 
    labs(x = "Order", y = "Hill numbers")
```


# Вопрос 6 {.tabset}

6. Есть ли виды-специалисты, приуроченные к отдельному типу берега (галечный, песчаный, тростниковый), или биотопу-синузии, или к плотным злаковым дернинам в целом? 

— Есть.

**Примечание. Использован IndVal - "индикаторная ценность вида". В форме APCF, как применено здесь, он принимает значения от 0 до 100%. Максимум достигается когда вид не встречается в пробах других типов, но встречается во всех пробах данного типа, причем представлен во всех них.**

**Примечание 2. Для синузий нужна какая-то иерархическая классификация, чтобы такой же подход можно было применить и для этого средового фактора. Вариантов два. Сделать это на основе вашего экспертного мнения или сделать это на основе каких-либо алгоритмов, например - классифицировать не население клещей по типу проб, а пробы по населению клещей. Вариант два считаю менее предпочтительным, т.к. нахожу его несколько рекурсивным, но в зарубежные коллеги так поступают часто**

```{r}
dummy <- data.frame(id = colnames(dfw)[-1]) %>% 
    left_join(labs, by = "id")
iv <- list()
iv$coast <- dfw %>% 
    column_to_rownames("sp") %>% 
    indval(., clas = dummy$coast, 
           significance = FALSE) %>% # 
    .$indval %>% 
    round(., 1) %>% 
    as.data.frame() %>% 
    rownames_to_column("species")
iv$skew <- dfw %>% 
    column_to_rownames("sp") %>% 
    indval(., clas = dummy$skew, 
           significance = FALSE) %>% # 
    .$indval %>% 
    round(., 1) %>% 
    as.data.frame() %>% 
    rownames_to_column("species")
iv$substrate <- dfw %>% 
    column_to_rownames("sp") %>% 
    indval(., clas = dummy$substrate, 
           significance = FALSE) %>% # 
    .$indval %>% 
    round(., 1) %>% 
    as.data.frame() %>% 
    rownames_to_column("species")
iv$soil <- dfw %>% 
    column_to_rownames("sp") %>% 
    indval(., clas = dummy$soil, 
           significance = FALSE) %>% # 
    .$indval %>% 
    round(., 1) %>% 
    as.data.frame() %>% 
    rownames_to_column("species")
iv$zone <- dfw %>% 
    column_to_rownames("sp") %>% 
    indval(., clas = dummy$zone, 
           significance = FALSE) %>% # 
    .$indval %>% 
    round(., 1) %>% 
    as.data.frame() %>% 
    rownames_to_column("species")
```

## Coast

```{r}
formattable::formattable(iv[[1]])
```

## Skew

```{r}
formattable::formattable(iv[[2]])
```

## Substrate

```{r}
formattable::formattable(iv[[3]])
```

## Soil

```{r}
formattable::formattable(iv[[4]])
```

## Zone

```{r}
formattable::formattable(iv$zone)
```

# Вопрос 10

10. Как кластеризуется население почвенных клещей (Oribatida, Mesostigmata порознь и вместе) отдельных проб?  Т.е. собираются ли в кластеры выборки из отдельных биотопов-синузий, а комплексы отдельных типов берега? 

— Да, должны, но все бывает… Выборки под всеми рогозами (с плотной дерниной, на песчаном и галечном пляжах)  могут собраться в один кластер.

```{r}
par.default <- par()
d1.bc <- vegan::vegdist(as.data.frame(t(dfw[,-1])), method = "bray", binary = FALSE)
d1.cs <- vegan::vegdist(as.data.frame(t(dfw[,-1])), method = "bray", binary = TRUE)
d0.bc <- vegan::vegdist(as.data.frame(t(dfw0[,-1])), method = "bray", binary = FALSE)
d0.cs <- vegan::vegdist(as.data.frame(t(dfw0[,-1])), method = "bray", binary = TRUE)

#general, numeric
c0.bc <- hclust(d0.bc, method  = "ward.D2") 
c0.bc_labs <- labs %>% 
    transmute(id = substr(id, 1, nchar(id)-1), plants.d, substrate, soil) %>% 
    left_join(tibble(id = labels(c0.bc)), ., by = "id") %>% 
    group_by(id) %>% 
    mutate_at(vars(-id), collapse_labels) %>% 
    ungroup() %>% 
    distinct() %>% 
    mutate(substr.color = colorise_labels(.$substrate), 
           soil.color   = colorise_labels(.$soil))

#general, binary
c0.cs <- hclust(d0.cs, method  = "ward.D2") 
c0.cs_labs <- labs %>% 
    transmute(id = substr(id, 1, nchar(id)-1), plants.d, substrate, soil) %>% 
    left_join(tibble(id = labels(c0.cs)), ., by = "id") %>% 
    group_by(id) %>% 
    mutate_at(vars(-id), collapse_labels) %>% 
    ungroup() %>% 
    distinct() %>% 
    mutate(substr.color = colorise_labels(.$substrate), 
           soil.color   = colorise_labels(.$soil))

#local, numeric
c1.bc <- hclust(d1.bc, method  = "ward.D2") 
c1.bc_labs <- labs %>% 
    transmute(id, plants.d, substrate, soil) %>% 
    left_join(tibble(id = labels(c1.bc)), ., by = "id") %>% 
    group_by(id) %>% 
    mutate_at(vars(-id), collapse_labels) %>% 
    ungroup() %>% 
    distinct() %>% 
    mutate(substr.color = colorise_labels(.$substrate), 
           soil.color   = colorise_labels(.$soil))

#local, binary
c1.cs <- hclust(d1.cs, method  = "ward.D2") 
c1.cs_labs <- labs %>% 
    transmute(id, plants.d, substrate, soil) %>% 
    left_join(tibble(id = labels(c1.cs)), ., by = "id") %>% 
    group_by(id) %>% 
    mutate_at(vars(-id), collapse_labels) %>% 
    ungroup() %>% 
    distinct() %>% 
    mutate(substr.color = colorise_labels(.$substrate), 
           soil.color   = colorise_labels(.$soil))
```

## Почва {.tabset}

### Объединенные данные, количественные

```{r}
par(mar=c(3,3,1,13))
c0.bc %>% 
    as.dendrogram() %>% 
    set("labels", paste0(c0.bc_labs$id, "_", c0.bc_labs$soil)) %>% 
    set("labels_colors", c0.bc_labs$soil.color) %>% 
    plot(horiz = TRUE)
```

### Объединенные данные, бинарные

```{r}
c0.cs %>% 
    as.dendrogram() %>% 
    set("labels", paste0(c0.cs_labs$id, "_", c0.cs_labs$soil)) %>% 
    set("labels_colors", c0.cs_labs$soil.color) %>% 
    plot(horiz = TRUE)
```

### Дробные данные, количественные

```{r}
par(mar=c(3,3,1,13), cex = 0.7)
c1.bc %>% 
    as.dendrogram() %>% 
    set("labels", paste0(c1.bc_labs$id, "_", c1.bc_labs$soil)) %>% 
    set("labels_colors", c1.bc_labs$soil.color) %>% 
    plot(horiz = TRUE)
```

### Дробные данные, бинарные

```{r}
par(mar=c(3,3,1,13), cex = 0.7)
c1.cs %>% 
    as.dendrogram() %>% 
    set("labels", paste0(c1.cs_labs$id, "_", c1.cs_labs$soil)) %>% 
    set("labels_colors", c1.cs_labs$soil.color) %>% 
    plot(horiz = TRUE)
```

## Субстрат {.tabset}

### Объединенные данные, количественные

```{r}
c0.bc %>% 
    as.dendrogram() %>% 
    set("labels", paste0(c0.bc_labs$id, "_", c0.bc_labs$substrate)) %>% 
    set("labels_colors", c0.bc_labs$substr.color) %>% 
    plot(horiz = TRUE)
```

### Объединенные данные, бинарные

```{r}
c0.cs %>% 
    as.dendrogram() %>% 
    set("labels", paste0(c0.cs_labs$id, "_", c0.cs_labs$substrate)) %>% 
    set("labels_colors", c0.cs_labs$substr.color) %>% 
    plot(horiz = TRUE)
```

### Дробные данные, количественные

```{r}
par(mar=c(3,3,1,13), cex = 0.7)
c1.bc %>% 
    as.dendrogram() %>%
    set("labels", paste0(c1.bc_labs$id, "_", c1.bc_labs$substrate)) %>% 
    set("labels_colors", c1.bc_labs$substr.color) %>% 
    plot(horiz = TRUE)
```

### Дробные данные, бинарные

```{r}
par(mar=c(3,3,1,13), cex = 0.7)
c1.cs %>% 
    as.dendrogram() %>% 
    set("labels", paste0(c1.cs_labs$id, "_", c1.cs_labs$substrate)) %>% 
    set("labels_colors", c1.cs_labs$substr.color) %>% 
    plot(horiz = TRUE)
```

## Синузии {.tabset}

### Объединенные данные, количественные

```{r}
c0.bc %>% 
    as.dendrogram() %>% 
    set("labels", paste0(c0.bc_labs$id, "_", c0.bc_labs$plants.d)) %>% 
    plot(horiz = TRUE)

```

### Объединенные данные, бинарные

```{r}
c0.cs %>% 
    as.dendrogram() %>% 
    set("labels", paste0(c0.cs_labs$id, "_", c0.cs_labs$plants.d)) %>% 
    plot(horiz = TRUE)
```

### Дробные данные, количественные

```{r}
par(mar=c(3,3,1,13), cex = 0.7)
c1.bc %>% 
    as.dendrogram() %>% 
    set("labels", paste0(c1.bc_labs$id, "_", c1.bc_labs$plants.d)) %>% 
    plot(horiz = TRUE)
```

### Дробные данные, бинарные

```{r}
par(mar=c(3,3,1,13), cex = 0.7)
c1.cs %>% 
    as.dendrogram() %>% 
    set("labels", paste0(c1.cs_labs$id, "_", c1.cs_labs$plants.d)) %>% 
    plot(horiz = TRUE)

dev.off() 
```








# Вопрос 10а

**Примечание. Вы попросили выяснить "как кластеризуются ...", что подразумевает кластерный анализ. Но представление многомерных данных "съедает", на мой взгляд, слишком много информации, поэтому я взял на себя смелость сделать ещё и ординацию. Тут тоже можно выделять кластеры различных уровней и порядков, но не требуется предположение о дихотомическом ветвлении в классификации. На переключаемых вкладках первым идет интерактивный график, где при наведении можно посмотреть id каждой из проб. На последующих вкладках топология точек такая же, просто они визуализированы по тому или иному фактору**

```{r}
my.pcoa <- function(dis, df){
    pcoa1 <- ape::pcoa(dis)
    eig <- pcoa1$values$Eigenvalues
    if(min(eig)<0){ 
        eig <- eig+min(eig)*-1
    }
    eig <- round(eig/sum(eig)*100, 1)[1:2]
    df <- pcoa1$vectors %>% 
        data.frame() %>% 
        rownames_to_column("id") %>% 
        as_tibble %>% 
        select(id, Axis.1, Axis.2) %>% 
        left_join(df, by = "id")
    list(df = df, eig = eig)
}
pcoa.plot <- function(df, eig, key, tt = NULL, st = NULL){
    select(df, id, Axis.1, Axis.2, environmental = all_of(key)) %>% 
        ggplot(., aes(Axis.1, Axis.2, color = environmental, 
                      shape = environmental, fill = environmental)) + 
        geom_point() + 
        labs(x = paste0("Axis 1 (", eig[1], "%)"), 
             y = paste0("Axis 2 (", eig[2], "%)"), 
             title = tt, subtitle = st)
}

d1.bc <- vegan::vegdist(as.data.frame(t(dfw[,-1])), method = "bray", binary = FALSE)
d1.cs <- vegan::vegdist(as.data.frame(t(dfw[,-1])), method = "bray", binary = TRUE)
d0.bc <- vegan::vegdist(as.data.frame(t(dfw0[,-1])), method = "bray", binary = FALSE)
d0.cs <- vegan::vegdist(as.data.frame(t(dfw0[,-1])), method = "bray", binary = TRUE)

pcoa1.bc <- my.pcoa(d1.bc, labs)
pcoa1.cs <- my.pcoa(d1.cs, labs)
pcoa0.bc <- my.pcoa(d0.bc, c0.bc_labs)
pcoa0.cs <- my.pcoa(d0.cs, c0.cs_labs)
```

## Дробные данные, количественные {.tabset}

### Общая конфигурация (топология)

```{r}
plotly::ggplotly(
    ggplot(pcoa1.bc[[1]], aes(Axis.1, Axis.2, color = id)) + 
        geom_point() + 
        theme(legend.position = "none") +
        labs(title = "All samples; bray-curtis similarity")
    )
```

### тип берега

```{r}
pcoa.plot(pcoa1.bc[[1]], pcoa1.bc[[2]], "coast", NULL, 
          "PCoA, bray-curtis similarity")
```

### Субстрат

```{r}
pcoa.plot(pcoa1.bc[[1]], pcoa1.bc[[2]], "substrate", NULL, 
          "PCoA, bray-curtis similarity")
```

### Почва

```{r}
pcoa.plot(pcoa1.bc[[1]], pcoa1.bc[[2]], "soil", NULL, 
          "PCoA, bray-curtis similarity")
```

## Дробные данные, качественные {.tabset}

### Общая конфигурация (топология)

```{r}
plotly::ggplotly(
    ggplot(pcoa1.cs[[1]], aes(Axis.1, Axis.2, color = id)) + 
        geom_point() + 
        theme(legend.position = "none") +
        labs(title = "All samples; jaccard similarity")
)
```

### тип берега

```{r}
pcoa.plot(pcoa1.cs[[1]], pcoa1.cs[[2]], "coast", NULL, 
          "PCoA, jaccard similarity")
```

### Субстрат

```{r}
pcoa.plot(pcoa1.cs[[1]], pcoa1.cs[[2]], "substrate", NULL, 
          "PCoA, jaccard similarity")
```

### Почва

```{r}
pcoa.plot(pcoa1.cs[[1]], pcoa1.cs[[2]], "soil", NULL, 
          "PCoA, jaccard similarity")
```

## Объединенные данные, количественные {.tabset}

### Общая конфигурация (топология)

```{r}
plotly::ggplotly(
    ggplot(pcoa0.bc[[1]], aes(Axis.1, Axis.2, color = id)) + 
        geom_point() + 
        theme(legend.position = "none") +
        labs(title = "United samples; bray-curtis similarity")
)
```

### Субстрат

```{r}
pcoa.plot(pcoa0.bc[[1]], pcoa0.bc[[2]], "substrate", NULL, 
          "PCoA, bray-curtis similarity")
```

### Почва

```{r}
pcoa.plot(pcoa0.bc[[1]], pcoa0.bc[[2]], "soil", NULL, 
          "PCoA, bray-curtis similarity")
```

## Объединенные данные, качественные {.tabset}

### Общая конфигурация (топология)

```{r}
plotly::ggplotly(
    ggplot(pcoa0.cs[[1]], aes(Axis.1, Axis.2, color = id)) + 
        geom_point() + 
        theme(legend.position = "none") +
        labs(title = "United samples; jaccard similarity")
)
```


### Субстрат

```{r}
pcoa.plot(pcoa0.cs[[1]], pcoa0.cs[[2]], "substrate", NULL, 
          "PCoA, jaccard similarity")
```

### Почва

```{r}
pcoa.plot(pcoa0.cs[[1]], pcoa0.cs[[2]], "soil", NULL, 
          "PCoA, jaccard similarity")
```

# Вопрос 11

11. Что в большей степени «вкладывает» с структуру комплекса клещей отдельного биотопа-синузии — собственно специфика биотопа-синузии или тип берега? 

— Возможны варианты. В нашем случае для такого анализа могут быть использованы только две пары серий — SmPbTu и SmSdTu (Typha australis и на гальке и на песке), а также, c натяжкой, SmPbTl и SmSdTa (потому, что Typha angustifolia, Ta, была на песке в смеси с Typha laxmannii, Tl; оба вида рогоза имеют сходную экологию и морфологию - с узкими листьями). Можно попробовать сравнить и небольшие тростниковые заросли на песчаном пляже  (SmSdFn) с  обширными тростниковыми зарослями (SmRsFd).

**Примечаение. Пока не смог разобраться, как включить более двух факторов в одну модель, поэтому пришлось пока построить две штуки. В первой склон объясняет 13.1% дисперсии, почва 9.5%, во второй - субстрат 4.7%, тип берега 9.4%. Соответственно, 63.3% дисперсии остаются необъясненными. Но уже эти соотношения можно сравнивать, интерпретируя как разный вклад факторов в формирование структуры населения. Про синузии пока не разобрался как их стандартизировать (см. примечание 2 к п. 6). В таком виде с ними работать не получится, надо как-то сгруппировать. **

```{r}
labs2 <- as_tibble(left_join(data.frame(id = colnames(dfw[,-1])), labs, by = "id"))

vegan::adonis2(d1.bc ~ skew + soil + substrate + coast, data = labs2, permutations = 999)
vegan::adonis2(d1.bc ~ substrate + coast, data = labs2, permutations = 999)
```